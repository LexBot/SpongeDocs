
<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Scheduler &mdash; Documentation Sponge 7.2.0</title>

    <link rel="shortcut icon" href="../_static/favicon.ico"/>




    <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />

    <link rel="stylesheet" href="../_static/spongedocs.css" type="text/css" />

        <link rel="index" title="Index"
              href="../genindex.html"/>        <link rel="search" title="Recherche" href="../search.html"/>    <link rel="top" title="Documentation Sponge 7.2.0" href="../index.html"/>        <link rel="up" title="Création d’un Plugin" href="index.html"/>        <link rel="next" title="Services" href="services.html"/>        <link rel="prev" title="Effets" href="effects.html"/>
  <script src="../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
    <div id="sp-logo-container" class="page-scroll">
        <a class="logo" href="../index.html">
            <img src="../_static/spongie-mark-dark.svg">
            <span>Sponge</span>
            <i class="fa fa-fw fa-chevron-down"></i>
        </a>
        <div id="sp-logo-menu">
            <ul id="sp-logo-dropdown">
                <li><a href="https://www.spongepowered.org"><i class="fa-fw fa fa-home"></i>Homepage</a></li>
                <li><a href="https://forums.spongepowered.org"><i class="fa-fw fa fa-comments"></i>Forums</a></li>
                <li><a href="https://github.com/SpongePowered"><i class="fa-fw fa fa-code"></i>Code</a></li>
                <li class="active"><a href="https://docs.spongepowered.org"><i class="fa-fw fa fa-book"></i>Docs</a></li>
                <li><a href="https://jd.spongepowered.org"><i class="fa-fw fa fa-graduation-cap"></i>Javadocs</a></li>
                <li><a href="https://forums.spongepowered.org/c/plugins/plugin-releases"><i class="fa-fw fa fa-plug"></i>Plugins</a></li>
                <li><a href="https://ore.spongepowered.org"><img src="../_static/ore.svg" alt="" class="fa-fw fa ore-logo">Ore <sup>Beta</sup></a></li>
                <li><a href="https://www.spongepowered.org/downloads"><i class="fa-fw fa fa-download"></i>Downloads</a></li>
                <li><a href="https://www.spongepowered.org/chat"><i class="fa-fw fa fa-comment"></i>Chat</a></li>
            </ul>
        </div>
    </div>

<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
                <ul>
<li class="toctree-l1"><a class="reference internal" href="../server/index.html">Créer un Serveur</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../versions/index.html">Stratégie de versioning</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../preparing/index.html">Préparation pour le développement</a></li>
</ul>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Création d’un Plugin</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="api-versions.html">Versions de l’API</a></li>
<li class="toctree-l2"><a class="reference internal" href="buildsystem.html">Build Systems</a></li>
<li class="toctree-l2"><a class="reference internal" href="workspace/index.html">Mise en Place de votre Espace de Travail</a></li>
<li class="toctree-l2"><a class="reference internal" href="project/index.html">Configurer Votre Projet</a></li>
<li class="toctree-l2"><a class="reference internal" href="plugin-identifier.html">Identifiants de Plugins</a></li>
<li class="toctree-l2"><a class="reference internal" href="plugin-class.html">Classe Principale du Plugin</a></li>
<li class="toctree-l2"><a class="reference internal" href="lifecycle.html">Cycle de vie des Plugins</a></li>
<li class="toctree-l2"><a class="reference internal" href="injection.html">Injection de Dépendances</a></li>
<li class="toctree-l2"><a class="reference internal" href="practices/index.html">Bonnes Pratiques</a></li>
<li class="toctree-l2"><a class="reference internal" href="optional/index.html">Optionnels</a></li>
<li class="toctree-l2"><a class="reference internal" href="logging.html">Journalisation (Logging) et Débogage</a></li>
<li class="toctree-l2"><a class="reference internal" href="text/index.html">Text</a></li>
<li class="toctree-l2"><a class="reference internal" href="commands/index.html">Commandes de Plugin</a></li>
<li class="toctree-l2"><a class="reference internal" href="event/index.html">Événements</a></li>
<li class="toctree-l2"><a class="reference internal" href="configuration/index.html">Configuration des plugins</a></li>
<li class="toctree-l2"><a class="reference internal" href="assets.html">L’API des Ressources</a></li>
<li class="toctree-l2"><a class="reference internal" href="data/index.html">La Data API</a></li>
<li class="toctree-l2"><a class="reference internal" href="blocks/index.html">Blocs</a></li>
<li class="toctree-l2"><a class="reference internal" href="entities/index.html">Entités</a></li>
<li class="toctree-l2"><a class="reference internal" href="items/index.html">Items</a></li>
<li class="toctree-l2"><a class="reference internal" href="trade-offers.html">Trade-Offers</a></li>
<li class="toctree-l2"><a class="reference internal" href="effects.html">Effets</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Scheduler</a></li>
<li class="toctree-l2"><a class="reference internal" href="services.html">Services</a></li>
<li class="toctree-l2"><a class="reference internal" href="database.html">Bases de données</a></li>
<li class="toctree-l2"><a class="reference internal" href="permissions.html">Permissions</a></li>
<li class="toctree-l2"><a class="reference internal" href="bans.html">Bans</a></li>
<li class="toctree-l2"><a class="reference internal" href="metrics.html">Collection de Metrics</a></li>
<li class="toctree-l2"><a class="reference internal" href="bookview.html">Views d’un Livre</a></li>
<li class="toctree-l2"><a class="reference internal" href="economy/index.html">Économie</a></li>
<li class="toctree-l2"><a class="reference internal" href="wgen/index.html">Génération du monde</a></li>
<li class="toctree-l2"><a class="reference internal" href="manager.html">Gestionnaire de Plugin</a></li>
<li class="toctree-l2"><a class="reference internal" href="game-profile-manager.html">Gestionnaire de Profil de Jeu</a></li>
<li class="toctree-l2"><a class="reference internal" href="offline-userplayer-data.html">Données du Joueur Hors-Ligne</a></li>
<li class="toctree-l2"><a class="reference internal" href="tab-lists.html">Tab Lists</a></li>
<li class="toctree-l2"><a class="reference internal" href="plugin-meta.html">Plugin Metadata</a></li>
<li class="toctree-l2"><a class="reference internal" href="ray-tracing.html">Ray Tracing</a></li>
<li class="toctree-l2"><a class="reference internal" href="debugging.html">Debugging d’un plugin</a></li>
<li class="toctree-l2"><a class="reference internal" href="tutorials.html">Tutoriels</a></li>
<li class="toctree-l2"><a class="reference internal" href="internals/index.html">Plugins dépendants des implémentations</a></li>
</ul>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../ore/index.html">Documentation d’Ore</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../contributing/index.html">Contribuer à Sponge</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../about/index.html">À propos du Projet Sponge</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../index.html">Sponge</a>
      </nav>


      <div class="wy-nav-content">
        <div class="rst-content">

 

<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html">Docs</a> &raquo;</li>
          <li><a href="index.html">Création d’un Plugin</a> &raquo;</li>
    <li>Scheduler</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/plugin/scheduler.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
  <div class="section" id="scheduler">
<h1>Scheduler<a class="headerlink" href="#scheduler" title="Lien permanent vers ce titre">¶</a></h1>
<p>Sponge dispose d’un <a class="reference external" href="https://spongedl.neptunepowered.org/javadocs/7.2.0/org/spongepowered/api/scheduler/Scheduler.html">Scheduler</a> qui vous permet de désigner des tâches à exécuter plus tard. Le <code class="docutils literal notranslate"><span class="pre">Scheduler</span></code> fournit un <a class="reference external" href="https://spongedl.neptunepowered.org/javadocs/7.2.0/org/spongepowered/api/scheduler/Task.Builder.html">Task.Builder</a> avec lequel vous pouvez spécifier les propriétés de la tâche telles que le délai, l’intervalle, le nom, la/l”(a)synchronicité, et le <code class="docutils literal notranslate"><span class="pre">Runnable</span></code> (voir <a class="reference internal" href="#task-properties"><span class="std std-ref">Propriétés d’une tâche</span></a>).</p>
<div class="section" id="task-builder">
<h2>Constructeur de Tâche<a class="headerlink" href="#task-builder" title="Lien permanent vers ce titre">¶</a></h2>
<p>Tout d’abord, obtenez une instance de <code class="docutils literal notranslate"><span class="pre">Task.Builder</span></code>:</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">org.spongepowered.api.scheduler.Task</span><span class="p">;</span>

<span class="n">Task</span><span class="p">.</span><span class="na">Builder</span> <span class="n">taskBuilder</span> <span class="o">=</span> <span class="n">Task</span><span class="p">.</span><span class="na">builder</span><span class="p">();</span>
</pre></div>
</div>
<p>La seule propriété requise est le <a class="reference external" href="https://docs.oracle.com/javase/8/docs/api/java/lang/Runnable.html">Runnable</a>, que vous pouvez spécifier en utilisant la méthode <a class="reference external" href="https://spongedl.neptunepowered.org/javadocs/7.2.0/org/spongepowered/api/scheduler/Task.Builder.html#execute-java.lang.Runnable-">Task.Builder#execute(Runnable)</a>:</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="n">taskBuilder</span><span class="p">.</span><span class="na">execute</span><span class="p">(</span><span class="k">new</span> <span class="n">Runnable</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">logger</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&quot;Yay! Schedulers!&quot;</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">});</span>
</pre></div>
</div>
<p>ou en utilisant la syntaxe de Java 8 avec <code class="docutils literal notranslate"><span class="pre">Task.Builder#execute(Runnable</span> <span class="pre">runnable)</span></code></p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="n">taskBuilder</span><span class="p">.</span><span class="na">execute</span><span class="p">(</span>
    <span class="p">()</span> <span class="o">-&gt;</span> <span class="p">{</span>
        <span class="n">logger</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&quot;Yay! Schedulers!&quot;</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">);</span>
</pre></div>
</div>
<p>ou en utilisant la syntaxe de Java 8 avec <code class="docutils literal notranslate"><span class="pre">Task.Builder#execute(Consumer&lt;Task&gt;</span> <span class="pre">task)</span></code></p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="n">taskBuilder</span><span class="p">.</span><span class="na">execute</span><span class="p">(</span>
    <span class="n">task</span> <span class="o">-&gt;</span> <span class="p">{</span>
        <span class="n">logger</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&quot;Yay! Schedulers! :&quot;</span> <span class="o">+</span> <span class="n">task</span><span class="p">.</span><span class="na">getName</span><span class="p">());</span>
    <span class="p">}</span>
<span class="p">);</span>
</pre></div>
</div>
<div class="section" id="task-properties">
<span id="id1"></span><h3>Propriétés d’une tâche<a class="headerlink" href="#task-properties" title="Lien permanent vers ce titre">¶</a></h3>
<p>En utilisant le <code class="docutils literal notranslate"><span class="pre">Task.Builder</span></code>, vous pouvez spécifier d’autres propriétés optionnelles, comme décrit ci-dessous.</p>
<table border="1" class="docutils">
<colgroup>
<col width="15%" />
<col width="22%" />
<col width="64%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Propriété</th>
<th class="head">Méthode Utilisée</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>delay</td>
<td><p class="first">delayTicks(long delay)</p>
<dl class="last docutils">
<dt>delay(long delay,</dt>
<dd>TimeUnit unit)</dd>
</dl>
</td>
<td><p class="first">Le montant optionnel de temps avant que la tâche soit exécutée.</p>
<p>Le temps est spécifié en nombre de ticks avec la méthode <code class="docutils literal notranslate"><span class="pre">delayTicks()</span></code>, ou il peut être communiqué en unité de temps plus commode en spécifiant un <a class="reference external" href="https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/TimeUnit.html">TimeUnit</a> avec la méthode delay().</p>
<p class="last"><em>Chacune de ces méthodes, mais pas les deux, peuvent être spécifiées par tâche.</em></p>
</td>
</tr>
<tr class="row-odd"><td>interval</td>
<td><dl class="first last docutils">
<dt>intervalTicks(</dt>
<dd>long interval)</dd>
<dt>interval(long interval,</dt>
<dd>TimeUnit unit)</dd>
</dl>
</td>
<td><p class="first">Le montant de temps entre la répétition de la tâche. Si une intervalle n’est pas spécifiée, la tâche ne sera pas répétée.</p>
<p>Le temps est spécifié en nombre de ticks avec la méthode <code class="docutils literal notranslate"><span class="pre">intervalTicks()</span></code>, ou il peut être communiqué en unité de temps plus commode en spécifiant un <a class="reference external" href="https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/TimeUnit.html">TimeUnit</a> avec la méthode interval().</p>
<p class="last"><em>Chacune de ces méthodes, mais pas les deux, peuvent être spécifiées par tâche.</em></p>
</td>
</tr>
<tr class="row-even"><td>synchronization</td>
<td>async()</td>
<td>Une tâche synchrone est lancée dans la boucle principale du jeu en série avec le cycle de tick. Si la méthode <code class="docutils literal notranslate"><span class="pre">Task.Builder#async</span></code> est utilisée, la tâche sera lancée de manière asynchrone. En conséquence, elle sera effectuée dans son propre thread, indépendamment du cycle de tick, et ne pourrait pas être thread-safe avec les données de jeu. (Voir <a class="reference internal" href="#asynchronous-tasks">Tâches asynchrones</a>.)</td>
</tr>
<tr class="row-odd"><td>name</td>
<td>name(String name)</td>
<td>La nom de la tâche. Par défaut, le nom d’une tâche sera PLUGIN_ID «&nbsp;-&nbsp;» ( «&nbsp;A-&nbsp;» | «&nbsp;S-&nbsp;» ) SERIAL_ID. Par exemple, le nom par défaut d’une tâche pourrait ressembler à «&nbsp;fooplugin-A-12&nbsp;». Deux tâches actives ne pourront pas avoir le même serial ID pour le même type de synchronisation. Si un nom de tâche est spécifié, il devrait être descriptif et aider les utilisateurs à déboguer votre plugin.</td>
</tr>
</tbody>
</table>
<p>Enfin, validez la tâche dans le scheduler, en utilisant la méthode <a class="reference external" href="https://spongedl.neptunepowered.org/javadocs/7.2.0/org/spongepowered/api/scheduler/Task.Builder.html#submit-java.lang.Object-">Task.Builder#submit(Object)</a>.</p>
<p>Et c’est tout! Pour résumer, une tâche planifiée totalement fonctionnelle qui se lancerait toutes les 5 minutes après un délai initial de 100 millisecondes pourrait être construite et validée en utilisant le code suivant:</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">java.util.concurrent.TimeUnit</span><span class="p">;</span>

<span class="n">PluginContainer</span> <span class="n">plugin</span> <span class="o">=</span> <span class="p">...;</span>

<span class="n">Task</span> <span class="n">task</span> <span class="o">=</span> <span class="n">Task</span><span class="p">.</span><span class="na">builder</span><span class="p">().</span><span class="na">execute</span><span class="p">(()</span> <span class="o">-&gt;</span> <span class="n">logger</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&quot;Yay! Schedulers!&quot;</span><span class="p">))</span>
    <span class="p">.</span><span class="na">async</span><span class="p">().</span><span class="na">delay</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="n">TimeUnit</span><span class="p">.</span><span class="na">MILLISECONDS</span><span class="p">).</span><span class="na">interval</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">TimeUnit</span><span class="p">.</span><span class="na">MINUTES</span><span class="p">)</span>
    <span class="p">.</span><span class="na">name</span><span class="p">(</span><span class="s">&quot;ExamplePlugin - Fetch Stats from Database&quot;</span><span class="p">).</span><span class="na">submit</span><span class="p">(</span><span class="n">plugin</span><span class="p">);</span>
</pre></div>
</div>
<p>Pour annuler une tâche, utilisez simplement la méthode <a class="reference external" href="https://spongedl.neptunepowered.org/javadocs/7.2.0/org/spongepowered/api/scheduler/Task.html#cancel--">Task#cancel()</a>:</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="n">task</span><span class="p">.</span><span class="na">cancel</span><span class="p">();</span>
</pre></div>
</div>
<p>Si vous devez annuler la tâche à partir de l’exécutable lui-même, vous pouvez plutôt opter pour l’utilisation d’un <code class="docutils literal notranslate"><span class="pre">Consumer&lt;Task&gt;</span></code> afin d’accéder à la tâche. L’exemple ci-dessous va planifier une tâche qui va compter à rebours depuis 60 et s’annuler elle-même en arrivant à 0.</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="nd">@Listener</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">onGameInit</span><span class="p">(</span><span class="n">GameInitializationEvent</span> <span class="n">event</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">Task</span> <span class="n">task</span> <span class="o">=</span> <span class="n">Task</span><span class="p">.</span><span class="na">builder</span><span class="p">().</span><span class="na">execute</span><span class="p">(</span><span class="k">new</span> <span class="n">CancellingTimerTask</span><span class="p">())</span>
        <span class="p">.</span><span class="na">interval</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">TimeUnit</span><span class="p">.</span><span class="na">SECONDS</span><span class="p">)</span>
        <span class="p">.</span><span class="na">name</span><span class="p">(</span><span class="s">&quot;Self-Cancelling Timer Task&quot;</span><span class="p">).</span><span class="na">submit</span><span class="p">(</span><span class="n">plugin</span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">private</span> <span class="kd">class</span> <span class="nc">CancellingTimerTask</span> <span class="kd">implements</span> <span class="n">Consumer</span><span class="o">&lt;</span><span class="n">Task</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">seconds</span> <span class="o">=</span> <span class="mi">60</span><span class="p">;</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">accept</span><span class="p">(</span><span class="n">Task</span> <span class="n">task</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">seconds</span><span class="o">--</span><span class="p">;</span>
        <span class="n">Sponge</span><span class="p">.</span><span class="na">getServer</span><span class="p">()</span>
            <span class="p">.</span><span class="na">getBroadcastChannel</span><span class="p">()</span>
            <span class="p">.</span><span class="na">send</span><span class="p">(</span><span class="n">Text</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="s">&quot;Remaining Time: &quot;</span><span class="o">+</span><span class="n">seconds</span><span class="o">+</span><span class="s">&quot;s&quot;</span><span class="p">));</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">seconds</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">task</span><span class="p">.</span><span class="na">cancel</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="admonition warning">
<p class="first admonition-title">Avertissement</p>
<p class="last"><strong>Toutes</strong> les tâches planifiées doivent soit regarder l”<a class="reference external" href="https://spongedl.neptunepowered.org/javadocs/7.2.0/org/spongepowered/api/GameState.html">état</a> actuel du <a class="reference external" href="https://spongedl.neptunepowered.org/javadocs/7.2.0/org/spongepowered/api/Game.html">Game</a>, ou doit être désinscrit du registre si ils ne sont plus nécessaires (ex : lors d’un <a class="reference external" href="https://spongedl.neptunepowered.org/javadocs/7.2.0/org/spongepowered/api/event/game/state/GameStoppingServerEvent.html">GameStoppingServerEvent</a>). C’est d’une importance particulière pour le client car il peut démarrer et arrêter le serveur plusieurs fois.</p>
</div>
</div>
<div class="section" id="asynchronous-tasks">
<h3>Tâches asynchrones<a class="headerlink" href="#asynchronous-tasks" title="Lien permanent vers ce titre">¶</a></h3>
<p>Les tâches asynchrones devraient être principalement utilisées pour un code qui mettrait un temps significatif à s’exécuter, à savoir des requêtes vers un autre serveur ou vers une base de données. Si cela est fait sur le thread principal, une requête vers un autre serveur pourrait grandement impacter les performances du jeu, puisque le prochain tick ne pourra être lancé/exécuté avant que la requête soit finie.</p>
<p>Puisque Minecraft s’exécute dans sa majorité sous un seul thread, il y a peu de choses que vous pouvez faire de manière asynchrone. Si vous devez exécuter une tâche asynchrone, vous devriez y exécuter tout le code qui n’utilise pas SpongeAPI ou n’affecte pas Minecraft, puis enregistrer une autre tâche <cite>synchrone</cite> qui gérera le code nécessitant l’API. Il y a quelque parties de Minecraft avec lesquelles vous pouvez travailler de manière <cite>asynchrone</cite>, incluant :</p>
<ul class="simple">
<li>Chat</li>
<li>Gestion des Permissions intégrée à Sponge</li>
<li>Scheduler de Sponge</li>
</ul>
<p>En plus, il y a d’autres opérations qui sont sûres pour être faites de manière asynchrone:</p>
<ul class="simple">
<li>Requêtes de réseaux indépendants</li>
<li>Système de fichier Entrée/Sortie (sauf les fichiers utilisés par Sponge)</li>
</ul>
<div class="admonition warning">
<p class="first admonition-title">Avertissement</p>
<p class="last">Accéder aux objets du jeu en dehors du thread principal peut causer des crashs, des inconsistances et d’autres problèmes qu’il serait préférable d’éviter. Si cela est mal fait, vous pouvez rencontrer une <code class="docutils literal notranslate"><span class="pre">ConcurrentModificationException</span></code> avec ou sans crash du serveur au mieux, ou d’une potentielle corruption de joueur/monde/serveur au pire.</p>
</div>
<div class="admonition warning">
<p class="first admonition-title">Avertissement</p>
<p class="last"><strong>Toutes</strong> les tâches planifiées doivent soit regarder l”<a class="reference external" href="https://spongedl.neptunepowered.org/javadocs/7.2.0/org/spongepowered/api/GameState.html">état</a> actuel du <a class="reference external" href="https://spongedl.neptunepowered.org/javadocs/7.2.0/org/spongepowered/api/Game.html">Game</a>, ou doit être désinscrit du registre si ils ne sont plus nécessaires (ex : lors d’un <a class="reference external" href="https://spongedl.neptunepowered.org/javadocs/7.2.0/org/spongepowered/api/event/game/state/GameStoppingServerEvent.html">GameStoppingServerEvent</a>). C’est d’une importance particulière pour le client car il peut démarrer et arrêter le serveur plusieurs fois.</p>
</div>
</div>
</div>
<div class="section" id="compatibility-with-other-libraries">
<h2>Compatibilité avec les autres librairies<a class="headerlink" href="#compatibility-with-other-libraries" title="Lien permanent vers ce titre">¶</a></h2>
<p>Pour que votre plugin augmente en taille et en possibilité, vous pouvez commencer à utiliser une des nombreuse librairies en concurrences, valable pour Java et sa JVM. Ces librairies ont tendances à s’appuyer sur l”<a class="reference external" href="https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/ExecutorService.html">ExecutorService</a> de Java afin de mieux diriger sur quel Thread il faut exécuter la tâche correspondante.</p>
<p>Pour permettre à ces librairies de fonctionner avec le <code class="docutils literal notranslate"><span class="pre">Scheduler</span></code> de Sponge la méthode suivante peut être utilisée:</p>
<ul class="simple">
<li><a class="reference external" href="https://spongedl.neptunepowered.org/javadocs/7.2.0/org/spongepowered/api/scheduler/Scheduler.html#createSyncExecutor-java.lang.Object-">Scheduler#createSyncExecutor(Object)</a> crée un <a class="reference external" href="https://spongedl.neptunepowered.org/javadocs/7.2.0/org/spongepowered/api/scheduler/SpongeExecutorService.html">SpongeExecutorService</a> qui exécute les tâches en passant par le scheduler synchrone de Sponge.</li>
<li><a class="reference external" href="https://spongedl.neptunepowered.org/javadocs/7.2.0/org/spongepowered/api/scheduler/Scheduler.html#createAsyncExecutor-java.lang.Object-">Scheduler#createAsyncExecutor(Object)</a> crée un <code class="docutils literal notranslate"><span class="pre">SpongeExecutorService</span></code> qui exécute les tâches en passant par le scheduler asynchrone de Sponge. Les tâches sont sujettes aux restrictions mentionnées dans <a class="reference internal" href="#asynchronous-tasks">Tâches asynchrones</a>.</li>
</ul>
<p>Une chose à garder à l’esprit est que chaque tâche qui interagit avec Sponge en dehors des interactions listées dans <a class="reference internal" href="#asynchronous-tasks">Tâches Asynchrones</a> doit être exécuté sur le ExecutorService crée avec <code class="docutils literal notranslate"><span class="pre">Scheduler#createSyncExecutor(Object)</span></code> pour être thread-safe.</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">org.spongepowered.api.scheduler.SpongeExecutorService</span><span class="p">;</span>

<span class="n">PluginContainer</span> <span class="n">plugin</span> <span class="o">=</span> <span class="p">...;</span>

<span class="n">SpongeExecutorService</span> <span class="n">minecraftExecutor</span> <span class="o">=</span> <span class="n">Sponge</span><span class="p">.</span><span class="na">getScheduler</span><span class="p">().</span><span class="na">createSyncExecutor</span><span class="p">(</span><span class="n">plugin</span><span class="p">);</span>

<span class="n">minecraftExecutor</span><span class="p">.</span><span class="na">submit</span><span class="p">(()</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="p">...</span> <span class="p">});</span>

<span class="n">minecraftExecutor</span><span class="p">.</span><span class="na">schedule</span><span class="p">(()</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="p">...</span> <span class="p">},</span> <span class="mi">10</span><span class="p">,</span> <span class="n">TimeUnit</span><span class="p">.</span><span class="na">SECONDS</span><span class="p">);</span>
</pre></div>
</div>
<p>Presque toutes les librairies ont une manière de s’adapter à l”<code class="docutils literal notranslate"><span class="pre">ExecutorService</span></code> pour planifier de manière native les tâches. À titre d’exemple les paragraphe suivants vont expliquer comment l”<code class="docutils literal notranslate"><span class="pre">ExecutorService</span></code> est utilisé dans bon nombre de librairies.</p>
<div class="section" id="completablefuture-java-8">
<h3>CompletableFuture (Java 8)<a class="headerlink" href="#completablefuture-java-8" title="Lien permanent vers ce titre">¶</a></h3>
<p>Avec Java 8 l’objet <a class="reference external" href="https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/CompletableFuture.html">CompletableFuture</a> a été ajouté à la library standard. Comparé à l’objet <code class="docutils literal notranslate"><span class="pre">Future</span></code>, celui-ci permet au développeur de fournir un callback appelé quand le futur se complète plutôt que de bloquer le thread jusqu’à ce que le future se réalise éventuellement.</p>
<p><a class="reference external" href="https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/CompletableFuture.html">CompletableFuture</a> est une interface qui possède généralement trois variations pour chacune de ses fonctions:</p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">CompletableFuture#&lt;function&gt;Async(...,</span> <span class="pre">Executor</span> <span class="pre">ex)</span></code> Exécute cette fonction en passant par <code class="docutils literal notranslate"><span class="pre">ex</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">CompletableFuture#&lt;function&gt;Async(...)</span></code> Exécute cette fonction en passant par <code class="docutils literal notranslate"><span class="pre">ForkJoinPool.commonPool()</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">CompletableFuture#&lt;function&gt;(...)</span></code> Exécute cette fonction sur un des thread du <code class="docutils literal notranslate"><span class="pre">CompletableFuture</span></code> précédemment complété.</li>
</ul>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">java.util.concurrent.CompletableFuture</span><span class="p">;</span>

<span class="n">PluginContainer</span> <span class="n">plugin</span> <span class="o">=</span> <span class="p">...;</span>

<span class="n">SpongeExecutorService</span> <span class="n">minecraftExecutor</span> <span class="o">=</span> <span class="n">Sponge</span><span class="p">.</span><span class="na">getScheduler</span><span class="p">().</span><span class="na">createSyncExecutor</span><span class="p">(</span><span class="n">plugin</span><span class="p">);</span>

<span class="n">CompletableFuture</span><span class="p">.</span><span class="na">supplyAsync</span><span class="p">(()</span> <span class="o">-&gt;</span> <span class="p">{</span>
    <span class="c1">// ASYNC: ForkJoinPool.commonPool()</span>
    <span class="k">return</span> <span class="mi">42</span><span class="p">;</span>
<span class="p">}).</span><span class="na">thenAcceptAsync</span><span class="p">((</span><span class="n">awesomeValue</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">{</span>
    <span class="c1">// SYNC: minecraftExecutor</span>
<span class="p">},</span> <span class="n">minecraftExecutor</span><span class="p">).</span><span class="na">thenRun</span><span class="p">(()</span> <span class="o">-&gt;</span> <span class="p">{</span>
    <span class="c1">// SYNC: minecraftExecutor</span>
<span class="p">});</span>
</pre></div>
</div>
</div>
<div class="section" id="rxjava">
<h3>RxJava<a class="headerlink" href="#rxjava" title="Lien permanent vers ce titre">¶</a></h3>
<p><a class="reference external" href="https://github.com/ReactiveX/RxJava">RxJava</a> est une implémentation du concept de <a class="reference external" href="http://reactivex.io/">Reactive Extensions</a> pour la JVM.</p>
<p>Le multithreading avec Rx est géré par plusieurs <a class="reference external" href="http://reactivex.io/documentation/scheduler.html">Schedulers</a>. En utilisant la fonction <code class="docutils literal notranslate"><span class="pre">Schedulers#from(Executor</span> <span class="pre">executor)</span></code>, l”<code class="docutils literal notranslate"><span class="pre">Executor</span></code> fournit par Sponge peut être transformé en <code class="docutils literal notranslate"><span class="pre">Scheduler</span></code>.</p>
<p>Un peu comme <code class="docutils literal notranslate"><span class="pre">CompletableFuture</span></code>, par défaut les actions sont exécutées sur le même thread qui a complété la partie précédente de la chaîne. Utilisez <code class="docutils literal notranslate"><span class="pre">Observable#observeOn(Scheduler</span> <span class="pre">scheduler)</span></code> pour changer de thread.</p>
<p>Une chose importante à garder à l’esprit est que l”<code class="docutils literal notranslate"><span class="pre">Observable</span></code> racine est invoqué sur le thread sur lequel <code class="docutils literal notranslate"><span class="pre">Observable#subscribe()</span></code> a été appelé. Si l’observable racine interagit avec Sponge, il doit être obligé d’être exécuté de manière synchrone en utilisant <code class="docutils literal notranslate"><span class="pre">Observable#subscribeOn(Scheduler</span> <span class="pre">scheduler)</span></code>.</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">rx.Observable</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">rx.Scheduler</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">rx.schedulers.Schedulers</span><span class="p">;</span>

<span class="n">PluginContainer</span> <span class="n">plugin</span> <span class="o">=</span> <span class="p">...;</span>

<span class="n">SpongeExecutorService</span> <span class="n">executor</span> <span class="o">=</span> <span class="n">Sponge</span><span class="p">.</span><span class="na">getScheduler</span><span class="p">().</span><span class="na">createSyncExecutor</span><span class="p">(</span><span class="n">plugin</span><span class="p">);</span>
<span class="n">Scheduler</span> <span class="n">minecraftScheduler</span> <span class="o">=</span> <span class="n">Schedulers</span><span class="p">.</span><span class="na">from</span><span class="p">(</span><span class="n">executor</span><span class="p">);</span>

<span class="n">Observable</span><span class="p">.</span><span class="na">defer</span><span class="p">(()</span> <span class="o">-&gt;</span> <span class="n">Observable</span><span class="p">.</span><span class="na">from</span><span class="p">(</span><span class="n">Sponge</span><span class="p">.</span><span class="na">getServer</span><span class="p">().</span><span class="na">getOnlinePlayers</span><span class="p">()))</span>
          <span class="p">.</span><span class="na">subscribeOn</span><span class="p">(</span><span class="n">minecraftScheduler</span><span class="p">)</span> <span class="c1">// defer -&gt; SYNC: minecraftScheduler</span>
          <span class="p">.</span><span class="na">observeOn</span><span class="p">(</span><span class="n">Schedulers</span><span class="p">.</span><span class="na">io</span><span class="p">())</span> <span class="c1">// -&gt; ASYNC: Schedulers.io()</span>
          <span class="p">.</span><span class="na">filter</span><span class="p">(</span><span class="n">player</span> <span class="o">-&gt;</span> <span class="p">{</span>
              <span class="c1">// ASYNC: Schedulers.io()</span>
              <span class="k">return</span> <span class="s">&quot;Flards&quot;</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">player</span><span class="p">.</span><span class="na">getName</span><span class="p">());</span>
          <span class="p">})</span>
          <span class="p">.</span><span class="na">observeOn</span><span class="p">(</span><span class="n">minecraftScheduler</span><span class="p">)</span> <span class="c1">// -&gt; SYNC: minecraftScheduler</span>
          <span class="p">.</span><span class="na">subscribe</span><span class="p">(</span><span class="n">player</span> <span class="o">-&gt;</span> <span class="p">{</span>
              <span class="c1">// SYNC: minecraftScheduler</span>
              <span class="n">player</span><span class="p">.</span><span class="na">kick</span><span class="p">(</span><span class="n">Text</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="s">&quot;Computer says no&quot;</span><span class="p">));</span>
          <span class="p">});</span>
</pre></div>
</div>
</div>
<div class="section" id="scala">
<h3>Scala<a class="headerlink" href="#scala" title="Lien permanent vers ce titre">¶</a></h3>
<p>Scala comes with a built-in <a class="reference external" href="https://www.scala-lang.org/api/current/#scala.concurrent.Future">Future</a> object which
a lot of scala framework mirror in design.
Most methods of the Future accept an
<a class="reference external" href="https://www.scala-lang.org/api/current/scala/concurrent/ExecutionContext.html">ExecutionContext</a> which
determined where that part of the operation is executed.
This is different from the CompletableFuture or RxJava since they default to executing on the same thread on which
the previous operation ended.</p>
<p>Le fait que toutes ces opérations tentent implicitement de trouver un <code class="docutils literal notranslate"><span class="pre">ExecutionContext</span></code> signifie que vous pouvez facilement utiliser le <code class="docutils literal notranslate"><span class="pre">ExecutionContext.global</span></code> par défaut et exécuter plus précisément les parties qui doivent être thread-safe sur le thread du serveur Sponge.</p>
<p>Pour éviter d’accidentellement planifier du travail à travers l”<code class="docutils literal notranslate"><span class="pre">ExecutorContext</span></code> de Sponge, un autre contexte doit être implicitement défini pour qu’il devienne le choix par défaut. Pour maintenir la sécurité des threads seulement sur les fonctions qui interagissent avec Sponge vous devrez avoir l’exécuteur de Sponge spécifié.</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">import</span> <span class="nn">scala.concurrent.ExecutionContext</span>

<span class="k">val</span> <span class="n">executor</span> <span class="k">=</span> <span class="nc">Sponge</span><span class="o">.</span><span class="n">getScheduler</span><span class="o">().</span><span class="n">createSyncExecutor</span><span class="o">(</span><span class="n">plugin</span><span class="o">)</span>

<span class="k">import</span> <span class="nn">ExecutionContext.Implicits.global</span>
<span class="k">val</span> <span class="n">ec</span> <span class="k">=</span> <span class="nc">ExecutionContext</span><span class="o">.</span><span class="n">fromExecutorService</span><span class="o">(</span><span class="n">executor</span><span class="o">)</span>

<span class="k">val</span> <span class="n">future</span> <span class="k">=</span> <span class="nc">Future</span> <span class="o">{</span>
    <span class="c1">// ASYNC: ExecutionContext.Implicits.global</span>
<span class="o">}</span>

<span class="n">future</span> <span class="n">foreach</span> <span class="o">{</span>
    <span class="k">case</span> <span class="n">value</span> <span class="k">=&gt;</span> <span class="c1">// SYNC: ec</span>
<span class="o">}(</span><span class="n">ec</span><span class="o">)</span>

<span class="n">future</span> <span class="n">map</span> <span class="o">{</span>
    <span class="k">case</span> <span class="n">value</span> <span class="k">=&gt;</span> <span class="mi">42</span> <span class="c1">// SYNC: ec</span>
<span class="o">}(</span><span class="n">ec</span><span class="o">).</span><span class="n">foreach</span> <span class="o">{</span>
    <span class="k">case</span> <span class="n">value</span> <span class="k">=&gt;</span> <span class="n">println</span><span class="o">(</span><span class="n">value</span><span class="o">)</span> <span class="c1">// ASYNC: ExecutionContext.Implicits.global</span>
<span class="o">}</span>
</pre></div>
</div>
</div>
</div>
</div>

           </div>
          </div>
<footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="services.html" class="btn btn-neutral float-right" title="Services" accesskey="n" rel="next">Suivant <span class="fa fa-angle-right"></span></a>
        <a href="effects.html" class="btn btn-neutral" title="Effets" accesskey="p" rel="prev"><span class="fa fa-angle-left"></span> Précédent</a>
    </div>

    <hr/>

    <section id="license-footer">
        <p>Except where otherwise noted,
            <a xmlns:dct="http://purl.org/dc/terms/" xmlns:cc="http://creativecommons.org/ns#" property="dct:title" rel="cc:attributionURL" href="https://github.com/SpongePowered/SpongeDocs">SpongeDocs</a>
            is licensed under a <a rel="license" href="https://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 International License</a>.
        </p>
        <a id="license-icons" rel="license" href="https://creativecommons.org/licenses/by-sa/4.0/" title="CC-BY-SA" aria-hidden="true">cba</a>
    </section>
</footer>        </div>
      </div>

    </section>

  </div>


<div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
        <i class="fa fa-book"> <span>SpongeDocs</span></i>
        v: 7.2.0
    <img src="../_static/flags/fr_FR.svg"
         alt="fr" title="Français">
        <span class="fa fa-caret-down"></span>
    </span>
    <div id="versions" class="rst-other-versions">




    </div>
</div>

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'7.2.0',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>      <script type="text/javascript" src="../_static/jquery.js"></script>      <script type="text/javascript" src="../_static/underscore.js"></script>      <script type="text/javascript" src="../_static/doctools.js"></script>      <script type="text/javascript" src="../_static/language_data.js"></script>      <script type="text/javascript" src="../_static/translations.js"></script>      <script type="text/javascript" src="../_static/spongedocs.js"></script>

    <script type="text/javascript" src="../_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
 
</body>
</html>